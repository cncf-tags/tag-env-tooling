name: Green Talks Scraper

on:
  workflow_call:
    inputs:
      output-path:
        required: true
        type: string
      repository:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        persist-credentials: false

    - name: Prepend line to the output file
      run: echo "### An automatically generated list of environmental sustainability-related talks at The Linux Foundation events" > ${{ inputs.output-path }}

    - name: Run Green Scraper tool
      run: |
        chmod +x green-talks-scraper/scraper.sh
        ./green-talks-scraper/scraper.sh >> ${{ inputs.output-path }}

    - name: Create pull request with updated event list
      run: |
        # Check if ${{ inputs.output-path }} has been modified
        if git diff --name-only | grep ${{ inputs.output-path }} || git ls-files --others --exclude-standard | grep ${{ inputs.output-path }}; then
            BRANCH_NAME="update-talks-$(date +'%Y%m%d%H%M')"
            git config --local user.email "workflow@green-talks-scraper.com"
            git config --local user.name "green-talks-scraper-workflow"
            git checkout -b $BRANCH_NAME
            git add ${{ inputs.output-path }}
            git commit -s -m "docs: update event list with Green Scraper [skip actions]"
            git remote set-url origin https://${GH_TOKEN}@github.com/${{ inputs.repository }}.git
            git push --set-upstream origin $BRANCH_NAME -f
            gh pr create --base main --head $BRANCH_NAME --title "Update the list of talks" --body "Update the list of talks"
        else
            echo "The list of talks is up to date"
        fi
      env:
        GH_TOKEN: ${{ secrets.token }}
